<!doctype html>
<html>
<head>
	<title>Visualization of food consumption and daily nutrition</title>
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="http://blockly.webduino.io/lib/jquery-1.9.1.min.js"></script>
	<script src="http://blockly.webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
	<script src="http://blockly.webduino.io/lib/webduino-blockly.js"></script>
	<script src="http://blockly.webduino.io/lib/firebase.js"></script>
	<script src="http://blockly.webduino.io/lib/runtime.min.js"></script>
  <script src="client.js"></script>
  <!-- include A-Frame obviously -->
  <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
  <!-- include ar.js for A-Frame -->
  <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script> 
  <script src="js/three.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script>
    // AFRAME.registerGeometry('example', {
    //   schema: {
    //     vertices: {
    //       default: ['0 0 0', '5 0 0', '6.54 4.75 0', '2.50 7.69 0', '-1.54 4.75 0'],
    //     }
    //   },

    //   init: function (data) {
    //     var geometry = new THREE.Geometry();
    //     geometry.groupsNeedUpdate = true;
    //     geometry.vertices = data.vertices.map(function (vertex) {
    //       var points = vertex.split(' ').map(function(x){return parseInt(x);});
    //       return new THREE.Vector3(points[0], points[1], points[2], points[4], points[5]);
    //     });
    //     geometry.computeBoundingBox();
    //     geometry.faces.push(new THREE.Face3(3, 4, 5));
    //     geometry.mergeVertices();
    //     geometry.computeFaceNormals();
    //     geometry.computeVertexNormals();
    //     this.geometry = geometry;
    //   }
    // });
  </script>

  <style>
  body { margin: 5px; padding: 0; box-sizing: border-box; }
  body { font: 13px Helvetica, Arial; }
  form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
  form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
  form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
  #messages { list-style-type: none; margin: 0; padding: 0; }
  #messages li { padding: 5px 10px; }
  #messages li:nth-child(odd) { background: #eee; }
  #messages p { padding: 5px 10px; background: #5DAC81; color:#0B1013; font-size:20px; }
  #scale-data-milk, #scale-data-broccoli, #scale-data-fish, #scale-data-orange, #scale-data-meat { font-size: 40px; pointer-events: auto!important;}
</style>
</head>
<body>


  <a-scene embedded arjs='sourceType: webcam;'>

    <!-- define a camera which will move according to the marker position -->

    <!-- marker milk -->
    <a-marker preset='custom' type='pattern' url='https://raw.githubusercontent.com/jjxie/SocketSensorTest/master/markers/milk.patt'>
      <a-box position='0 0.1 0' rotation="0 45 0" depth="0.5" height="0.5" width="0.5" material='opacity: 0.5; color="#4CC3D9'></a-box>
      <a-sphere id="milk" position="0 0.5 0" radius="0.3" color="#EF2D5E"></a-sphere>
      <a-text id="milkText" position="1 1 0.5" rotation="-90 0 -180" value="Milk" color="#D05A6E"></a-text>
      <!-- <a-entity geometry="primitive: example; vertices: 0 0 0, 5 0 0, 6.54 4.75 0, 2.50 7.69 0, -1.54 4.75 0"></a-entity> -->
    </a-marker>

    <!-- marker orange -->
    <a-marker preset='custom' type='pattern' url='https://raw.githubusercontent.com/jjxie/SocketSensorTest/master/markers/orange.patt'>
      <a-box id="orange" position='0 1 0' depth="0.5" height="0.5" width="0.5" color="#F9BF45">
        <a-animation attribute="material.color"  begin="2000" from="white" to="#F9BF45" dur="2000" repeat="indefinite"></a-animation>
        <a-animation attribute="rotation" dur="10000" fill="forwards" to="0 360 0" repeat="indefinite"></a-animation>
      </a-box>
      <a-text id="orangeText" position="1 1 0.5" rotation="-90 0 -180" value="Orange" color="#D05A6E"></a-text>
    </a-marker>

    <!-- marker meat -->
    <a-marker preset='custom' type='pattern' url='https://raw.githubusercontent.com/jjxie/SocketSensorTest/master/markers/meat.patt'>
      <a-sphere id="sphereTest" position='0 0.1 0' radius="0.3" color="#2EA9DF"></a-sphere>
      <a-text id="meatText" position="1 1 0.5" rotation="-90 0 -180" value="broccoli" color="#D05A6E"></a-text>
    </a-marker>

    <!-- marker broccoli -->
    <a-marker preset='custom' type='pattern' url='https://raw.githubusercontent.com/jjxie/SocketSensorTest/master/markers/broccoli.patt'>
      <a-sphere position="0 0.5 0" radius="0.3" color="#1B813E"></a-sphere>
      <a-text id="broccoliText" position="1 1 0.5" rotation="-90 0 -180" value="broccoli" color="#D05A6E"></a-text>
    </a-marker>

    <!-- marker fish -->
    <a-marker preset='custom' type='pattern' url='https://raw.githubusercontent.com/jjxie/SocketSensorTest/master/markers/fish.patt'>
      <a-sphere position="0 0.5 0" radius="0.3" color="#2EA9DF">
        <a-animation attribute="material.color" from="white" to="#2EA9DF" dur="3000" repeat="indefinite"></a-animation>
      </a-sphere>
      <a-text id="fishText" position="1 1 0.5" rotation="-90 0 -180" value="Orange" color="#D05A6E"></a-text>
    </a-marker>

    <!-- marker hiro -->
    <a-marker preset='hiro'>
      <a-sphere position="0 0.3 0" radius="0.5" color="#F75C2F"></a-sphere>
      <a-text position="1 1 0.5" rotation="-90 0 -180" value="Now Interactable" color="#D05A6E"></a-text>
      <a-text position="1 1.5 -0.5" rotation="-180 0 -180" value="haha" color="#2B5F75"></a-text>
    </a-marker>

    <!-- camera -->
    <a-entity camera></a-entity>

  </a-scene>


  <!-- scale data area on the webpage-->
  <div><span id="scale-data-milk">Milk: 0.00 g</span></div>
  <div class="progress">
    <div id="theprogressbarMilk" class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <div><span id="scale-data-orange">Orange: 0.00 g</span></div>
  <div class="progress">
    <div id="theprogressbarOrange" class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <div><span id="scale-data-meat">Meat: 0.00 g</span></div>
  <div class="progress">
    <div id="theprogressbarMeat" class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <div><span id="scale-data-broccoli">Broccoli: 0.00 g</span></div>
  <div class="progress">
    <div id="theprogressbarBroccoli" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <div><span id="scale-data-fish">Fish: 0.00 g</span></div>
  <div class="progress">
    <div id="theprogressbarFish" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <!-- Message box area -->
  <ul id="messages"></ul>
  <!-- <form action="">
    <input id="m" autocomplete="off" /><button>Send</button>
  </form> -->

  <!-- set frenquency -->
  <div class="container">
    <h1>WeMos D1 Web Control Panel</h1>
    <div class="row">
      <div class="col-md-12">
        <h4>LED Pulse Delay (ms)</h4>
        <p><input type="text" class="form-control" id="ledDelay" name="ledDelay" value="1000" /></p>
        <p><button id="ledSet" class="btn btn-primary">Set Delay</button></p>
      </div>
    </div>
  </div>

  <script>
    var socket = io.connect('http://192.168.0.100:3000',{secure: true});
    //Get AR scene
    var sceneEl = document.querySelector('a-scene');

    socket.on('ledFrequency', function (data) {
      console.log("Set LED frequency ",data);
    });

    $('#ledSet').on('click',function(){
      var tmp = parseInt($('#ledDelay').val(),10);
      console.log("Setting LED Delay:",tmp)
      socket.emit('ledFrequencySet',tmp);
    });

    // Message notifys Online
    socket.on('online', function(txt){
      $('#messages').append($('<p>').text(txt + " is online now!"));
      sceneEl.querySelector('#sphereTest').setAttribute('color', '#2B5F75');
      console.log("sphereEl ", sceneEl.querySelector('#sphereTest'));
    });

    // Message notifys offline
    socket.on('offline', function(txt){
      $('#messages').append($('<p>').text(txt + " is offline now!"));
      sceneEl.querySelector('#sphereTest').setAttribute('color', '#F75C2F');    
    });

    // Milk selection show detailed information
    socket.on('milkIsSelected', function(txt){
      sceneEl.querySelector('#milkText').setAttribute('value', "Milk is selected"); 
      sceneEl.querySelector('#milk').setAttribute('color', '#F75C2F');    
    });

    socket.on('milkIsDeselected', function(txt){
      sceneEl.querySelector('#milkText').setAttribute('value', "Milk is deselected");  
      sceneEl.querySelector('#milk').setAttribute('color', '#000000');   
    });

    // Orange selection show detailed information
    socket.on('orangeIsSelected', function(txt){
      sceneEl.querySelector('#orangeText').setAttribute('value', "Orange is selected"); 
      sceneEl.querySelector('#orange').setAttribute('color', '#F75C2F');     
    });

    socket.on('orangeIsDeselected', function(txt){
      sceneEl.querySelector('#orangeText').setAttribute('value', "Orange is deselected");  
      sceneEl.querySelector('#orange').setAttribute('color', '#000000');   
    });

    // Meat selection show detailed information
    socket.on('meatIsSelected', function(txt){   
      sceneEl.querySelector('#meatText').setAttribute('value', "Meat is selected"); 
    });

    socket.on('meatIsDeselected', function(txt){ 
      sceneEl.querySelector('#meatText').setAttribute('value', "Meat is deselected"); 
    });

    // Broccoli selection show detailed information
    socket.on('broccoliIsSelected', function(txt){   
      sceneEl.querySelector('#broccoliText').setAttribute('value', "Broccoli is selected"); 
    });

    socket.on('broccoliIsDeselected', function(txt){ 
      sceneEl.querySelector('#broccoliText').setAttribute('value', "Broccoli is deselected");
    });

    // Fish selection show detailed information
    socket.on('fishIsSelected', function(txt){
      sceneEl.querySelector('#fishText').setAttribute('value', "Fish is selected");   
    });

    socket.on('fishIsDeselected', function(txt){ 
      sceneEl.querySelector('#fishText').setAttribute('value', "Fish is deselected"); 
    });


    $(function () {
    	// var photocell;

      // // Send message
      // $('form').submit(function(){
      // 	socket.emit(s'chat message', $('#m').val());
      // 	$('#m').val('');
      // 	return false;
      // });
      // socket.on('chat message', function(msg){
      // 	$('#messages').append($('<li>').text(msg));
      // });

      // // Webduino Smart Set sensor rgb color 
      // boardReady({board: 'Smart', url: '192.168.0.106'}, function (board) {
      //   board.systemReset();
      //   board.samplingInterval = 50;
      //   rgbled = getRGBLedCathode(board, 15, 12, 13);
      //   rgbled.setColor(0,0,0);
      // });

      // // Connect to Smart and emit sensor data
      // boardReady({board: 'Smart', url: '192.168.0.103'}, function (board) {
      //   board.systemReset();
      //   board.samplingInterval = 50;
      //   photocell = getPhotocell(board, 0);
      //   rgbledRed = getRGBLedCathode(board, 15, 12, 13);
      //   rgbledRed.setColor(255,0,0);
      //   photocell.on(function(val){
      //     photocell.detectedVal = val;
      //     redValue = (Math.round((((photocell.detectedVal - (0)) * (1/((1)-(0)))) * ((100)-(0)) + (0))*100))/100;
      //     socket.emit('sensor data red', redValue);
      //   });
      // });

      // Set milke weight data, max 1kg
      socket.on('scaleDataMilk', function(milk){
        console.log("Milk " + milk);
        var percentageMilk = milk/1000 * 100;
        $('#scale-data-milk').text("Milk:  " + milk + " g");
        $('#theprogressbarMilk').attr('aria-valuenow', percentageMilk).css('width', percentageMilk + '%');
      });

      // Set orange weight data, max 5kg
      socket.on('scaleDataOrange', function(orange){
        console.log("Orange " + orange);
        var percentageOrange = orange/5000 * 100;
        $('#scale-data-orange').text("Orange:  " + orange + " g");
        $('#theprogressbarOrange').attr('aria-valuenow', percentageOrange).css('width', percentageOrange + '%');
      }); 

      // Set meat weight data, max 5kg
      socket.on('scaleDataMeat', function(meat){
        console.log("Meat " + meat);
        var percentageMeat = meat/5000 * 100;
        $('#scale-data-meat').text("Meat:  " + meat + " g");
        $('#theprogressbarMeat').attr('aria-valuenow', percentageMeat).css('width', percentageMeat + '%');
      });

      // Set brocoli weight data, max 1kg
      socket.on('scaleDataBroccoli', function(broccoli){
        console.log("Broccoli " + broccoli);
        var percentageBroccoli = broccoli/1000 * 100;
        $('#scale-data-broccoli').text("Broccoli:  " + broccoli + " g");
        $('#theprogressbarBroccoli').attr('aria-valuenow', percentageBroccoli).css('width', percentageBroccoli + '%');
      });

      // Set fish weight data, max 1kg 
      socket.on('scaleDataFish', function(fish){
        console.log("Fish " + fish);
        var percentageFish = fish/1000 * 100;
        $('#scale-data-fish').text("Fish:  " + fish + " g");
        $('#theprogressbarFish').attr('aria-valuenow', percentageFish).css('width', percentageFish + '%');
      });



      // If content updates, get all the content again
      socket.on('update content', function(data){
        var buffer = new Uint8Array(data);
        var fileString= String.fromCharCode.apply(null, buffer);
        var obj = JSON.parse(fileString)
        console.log(obj);
        for (i = 0; i < obj.length; i++) {
          $('#messages').append($('<li>').text(obj[i].ID));   
        }    
      });

      // Get the intial content when connected for the first time
      socket.on('initial content', function(data){
        var buffer = new Uint8Array(data);
        var fileString= String.fromCharCode.apply(null, buffer);
        var obj = JSON.parse(fileString)
        for (i = 0; i < obj.length; i++) {
          $('#messages').append($('<li>').text(obj[i].ID));
        }
      });

    });
  </script>
</body>
</html>